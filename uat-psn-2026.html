<script>
  google.charts.load("current", { packages: ["corechart"] });

  // LABEL untuk judul kartu (bebas), HEADERS untuk target kolom di sheet
  const HEADERS = [
    "A.01 -  Mengaktifkan Fitur Input Verifikasi di Set Global",
    "A.02 -  Fitur Verifikasi di fase Pembahasan dan Penilaian",
    "B.01 -  Input Acuan Unit Cost di Fase Pra-Usulan",
    "B.02 -   Kolom Acuan Unit Cost Muncul ketika User Menambahkan Usulan",
    "B.03 -  Ubah Referensi Usulan",
    "B.04 - Filter Rincian",
    "B.05 -  Melakukan Sync Detail Rincian",
    "B.06 -   Melakukan Approval via Box Approval",
    "B.07 -   Melakukan Approval via Tabular Approval",
    "B.08 -  Download Kertas Kerja dari portal K/L dan Dit"
  ];
  const LABELS = [
    "A.01 - Aktifkan Fitur Verifikasi", "A.02 - Fitur Verifikasi di Pembahasan",
    "B.01 - Input Acuan Unit Cost", "B.02 - Kolom Acuan Unit Cost",
    "B.03 - Ubah Referensi Usulan", "B.04 - Filter Rincian",
    "B.05 - Sync Detail Rincian", "B.06 - Approval via Box",
    "B.07 - Approval via Tabular", "B.08 - Download Kertas Kerja"
  ];

  // GSheet CSV (biarkan sesuai punyamu)
  const SHEET_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ9vUB226vtDRMfa_alM52lTh7pbAeXAdJxp_mYbgr6hmLvanAOj8r7hDp8ioCBAEkOvUwjl8nOdyso/pub?output=csv";

  const STATE = { rows: [], charts: [], measured: null, headerKeyCache: new Map() };

  const STATUS_KEYS = ["Berhasil", "Gagal", "Kosong"];
  const COLORS = { Berhasil: "#4CAF50", Gagal: "#F44336", Kosong: "#9E9E9E" };

  // ==== Normalisasi string & pencocokan kolom ====
  const norm = s => (s || "")
    .toString()
    .replace(/\s+/g, " ")
    .replace(/\n/g, " ")
    .trim()
    .toLowerCase();

  const collapse = s => norm(s).replace(/\s+/g, ""); // buang semua spasi

  // Ambil prefix kode dari judul (contoh "A.01" dari "A.01 -  ...")
  const headerCode = h => (h.split("-")[0] || "").trim();

  // Kandidat nama kolom untuk "Instansi"
  const INST_CANDIDATES = [
    "Instansi/Unit Kerja",
    "Instansi / Unit Kerja",
    "Instansi",
    "Unit Kerja",
    "Instansi/ Unit Kerja",
    "Instansi - Unit Kerja"
  ].map(norm);

  function cleanHeader(header) { return header.replace(/\s+/g, ' ').replace(/\n/g, '').trim(); }

  // Temukan kunci kolom di sebuah row untuk header target:
  // 1) match bersih penuh
  // 2) match prefix kode (A.01, B.03, dsb)
  // 3) match longgar (abaikan spasi ganda)
  function findHeaderKey(row, desiredHeader) {
    const cacheKey = desiredHeader + "||" + Object.keys(row).join("|");
    if (STATE.headerKeyCache.has(cacheKey)) return STATE.headerKeyCache.get(cacheKey);

    const keys = Object.keys(row);
    const desiredNorm = norm(desiredHeader);
    const desiredCollapse = collapse(desiredHeader);
    const code = headerCode(desiredHeader).toLowerCase();

    // 1) exact-normalized match
    let found = keys.find(k => norm(k) === desiredNorm);
    if (found) { STATE.headerKeyCache.set(cacheKey, found); return found; }

    // 2) prefix-kode match (contoh: kolom "A.01 – ..." atau "A.01 ..." atau "A.01—")
    if (code) {
      found = keys.find(k => norm(k).startsWith(code));
      if (found) { STATE.headerKeyCache.set(cacheKey, found); return found; }
    }

    // 3) loose match (abaikan spasi/variasi kecil)
    found = keys.find(k => collapse(k) === desiredCollapse);
    if (found) { STATE.headerKeyCache.set(cacheKey, found); return found; }

    // 4) fallback: cari kolom yang mengandung kode di mana saja
    if (code) {
      found = keys.find(k => norm(k).includes(code));
      if (found) { STATE.headerKeyCache.set(cacheKey, found); return found; }
    }

    STATE.headerKeyCache.set(cacheKey, null);
    return null;
  }

  // Ambil nama instansi dari row dengan toleransi variasi header
  function getInstansi(row) {
    const keys = Object.keys(row);
    // Cari kandidat terbaik
    let key = keys.find(k => INST_CANDIDATES.includes(norm(k)));
    if (!key) {
      // fallback: temukan yang mengandung kata "instansi" atau "unit kerja"
      key = keys.find(k => /\b(instansi|unit\s*kerja)\b/i.test(k));
    }
    const val = key ? (row[key] || "").toString().trim() : "";
    return val || "(Tidak tercatat)";
  }

  // Pemetaan alias status → 3 kategori
  const STATUS_ALIASES = {
    "berhasil": "Berhasil", "sukses": "Berhasil", "ok": "Berhasil", "ya": "Berhasil", "done": "Berhasil",
    "gagal": "Gagal", "tidak": "Gagal", "tdk": "Gagal", "fail": "Gagal", "error": "Gagal", "belum": "Gagal",
    "": "Kosong", "-": "Kosong", "kosong": "Kosong", "n/a": "Kosong", "na": "Kosong", "null": "Kosong"
  };
  function normalizeStatus(raw) {
    const s = norm(raw);
    if (STATUS_ALIASES.hasOwnProperty(s)) return STATUS_ALIASES[s];
    // default: jika bukan "berhasil" → cek kata kunci; selain itu anggap "Kosong"
    if (/berhasil|sukses|ok|ya|done/i.test(raw)) return "Berhasil";
    if (/gagal|tidak|fail|error|belum/i.test(raw)) return "Gagal";
    return raw ? "Kosong" : "Kosong";
  }

  function headerHeight() {
    const ids = ["title", "meta", "participant-list"];
    return ids.reduce((h, id) => { const el = document.getElementById(id); return h + (el ? el.getBoundingClientRect().height : 0); }, 0) + 6;
  }

  function measureCardChrome() {
    const sample = document.querySelector(".chart-container");
    if (!sample) return { titleH: 18, summaryH: 18, vPad: 16, border: 2, gap: 10, gridPad: 20 };
    const title = sample.querySelector(".chart-title");
    const summary = sample.querySelector(".summary");
    const cs = getComputedStyle(sample);
    const titleH = title ? Math.ceil(title.getBoundingClientRect().height) : 0;
    const summaryH = summary ? Math.ceil(summary.getBoundingClientRect().height) : 0;
    const vPad = parseFloat(cs.paddingTop) + parseFloat(cs.paddingBottom);
    const border = parseFloat(cs.borderTopWidth) + parseFloat(cs.borderBottomWidth);
    const gap = 10, gridPad = 20;
    return { titleH, summaryH, vPad, border, gap, gridPad };
  }

  function computeLayout(nCharts) {
    const availW = window.innerWidth;
    const headerH = headerHeight();
    document.documentElement.style.setProperty("--headerH", headerH + "px");
    const availH = Math.max(0, window.innerHeight - headerH);

    const M = STATE.measured || { titleH: 18, summaryH: 18, vPad: 16, border: 2, gap: 10, gridPad: 20 };

    const minColWidth = 260;
    const maxColsByW = Math.max(1, Math.floor((availW - M.gridPad + M.gap) / (minColWidth + M.gap)));

    const chromePerCard = M.titleH + M.summaryH + M.vPad + M.border;
    const GRID_TOP_BOTTOM = 10 + 10 + 52;
    const SAFE = 6;

    let best = { cols: 1, rows: nCharts, chartH: 120 };

    for (let cols = maxColsByW; cols >= 1; cols--) {
      const rows = Math.ceil(nCharts / cols);
      const totalChrome = rows * chromePerCard + (rows - 1) * M.gap + GRID_TOP_BOTTOM;
      const usableForCharts = availH - totalChrome;
      const chartH = Math.floor(usableForCharts / rows) - SAFE;
      if (chartH > (best.chartH || 0)) best = { cols, rows, chartH };
    }

    best.chartH = Math.max(100, best.chartH);
    return best;
  }

  function buildContainers() {
    const wrap = document.getElementById("charts");
    wrap.innerHTML = ""; STATE.charts = [];
    HEADERS.forEach((_, i) => {
      const card = document.createElement("div"); card.className = "chart-container";
      const ttl = document.createElement("div"); ttl.className = "chart-title"; ttl.textContent = LABELS[i]; card.appendChild(ttl);
      const box = document.createElement("div"); box.className = "chart-box"; box.id = `chart_${i}`; card.appendChild(box);
      const sum = document.createElement("div"); sum.className = "summary"; sum.id = `summary_${i}`; card.appendChild(sum);
      wrap.appendChild(card);
      STATE.charts.push({ boxId: box.id, sumId: sum.id });
    });
    STATE.measured = measureCardChrome();
  }

  // Tooltip HTML breakdown per instansi
  function makeTooltip(status, total, breakdownMap) {
    const entries = Object.entries(breakdownMap).sort((a, b) => b[1] - a[1]);
    const list = entries.map(([name, c]) => `${name} (${c})`).join(", ");
    const title = `${status}: ${total}`;
    return `
      <div class="tt">
        <strong>${title}</strong>
        <div class="list">${list || "-"}</div>
      </div>`;
  }

  function drawAllCharts() {
    const rows = STATE.rows;
    if (!STATE.measured) STATE.measured = measureCardChrome();

    const layout = computeLayout(HEADERS.length);
    document.getElementById("charts").style.setProperty("--cols", layout.cols);
    document.querySelectorAll(".chart-box").forEach(el => { el.style.height = layout.chartH + "px"; });

    HEADERS.forEach((header, i) => {
      // aggregator
      const counts = { Berhasil: 0, Gagal: 0, Kosong: 0 };
      const byInstansi = { Berhasil: {}, Gagal: {}, Kosong: {} };

      rows.forEach(row => {
        const key = findHeaderKey(row, header);
        const raw = key ? (row[key] ?? "") : "";
        const status = normalizeStatus(raw);
        counts[status]++;

        const inst = getInstansi(row);
        byInstansi[status][inst] = (byInstansi[status][inst] || 0) + 1;
      });

      const total = counts.Berhasil + counts.Gagal + counts.Kosong;
      const pctB = total ? ((counts.Berhasil / total) * 100).toFixed(1) : 0;
      const pctG = total ? ((counts.Gagal / total) * 100).toFixed(1) : 0;

      // DataTable dengan tooltip HTML
      const dt = new google.visualization.DataTable();
      dt.addColumn('string', 'Status');
      dt.addColumn('number', 'Jumlah');
      dt.addColumn({ type: 'string', role: 'tooltip', p: { html: true } });

      STATUS_KEYS.forEach(st => {
        const tip = makeTooltip(st, counts[st], byInstansi[st]);
        dt.addRow([st, counts[st], tip]);
      });

      const options = {
        legend: { position: 'bottom', alignment: 'center', textStyle: { fontSize: 11 } },
        slices: {
          0: { color: COLORS.Berhasil }, 1: { color: COLORS.Gagal }, 2: { color: COLORS.Kosong }
        },
        chartArea: { left: '6%', top: '6%', width: '88%', height: '78%' },
        tooltip: { isHtml: true },
      };

      const chart = new google.visualization.PieChart(document.getElementById(`chart_${i}`));
      chart.draw(dt, options);

      // Summary bawah kartu
      const sumEl = document.getElementById(`summary_${i}`);
      sumEl.innerHTML = `Berhasil: ${counts.Berhasil} (${pctB}%) &nbsp; | &nbsp; Gagal: ${counts.Gagal} (${pctG}%)`;
    });
  }

  function updateParticipantInfo(data) {
    const instansiCounts = {};
    data.forEach(row => {
      const instansi = getInstansi(row);
      if (instansi) instansiCounts[instansi] = (instansiCounts[instansi] || 0) + 1;
    });
    const instansiEntries = Object.entries(instansiCounts).sort((a, b) => a[0].localeCompare(b[0]));
    const totalParticipant = instansiEntries.reduce((s, [, c]) => s + c, 0);
    document.getElementById("meta").innerHTML = `<strong>Total Partisipan:</strong> ${totalParticipant}`;
    document.getElementById("participant-list").innerText = instansiEntries.map(([n, c]) => `${n} (${c})`).join(" | ");
  }

  function loadDataAndDraw() {
    Papa.parse(SHEET_CSV_URL, {
      download: true, header: true, skipEmptyLines: true,
      complete: function (res) {
        // filter baris kosong total
        STATE.rows = (res.data || []).filter(r => Object.values(r).some(v => (v ?? "").toString().trim() !== ""));
        updateParticipantInfo(STATE.rows);
        buildContainers();
        drawAllCharts();
      },
      error: function (err) {
        console.error("Parse error:", err);
        document.getElementById("charts").innerText = "Gagal memuat data.";
      }
    });
  }

  const redraw = () => { buildContainers(); drawAllCharts(); };
  window.addEventListener("resize", () => requestAnimationFrame(redraw));
  window.addEventListener("orientationchange", () => setTimeout(() => requestAnimationFrame(redraw), 200));

  google.charts.setOnLoadCallback(() => {
    loadDataAndDraw();
  });
</script>
